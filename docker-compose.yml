### Never send your "passwords" in Production ###

x-base: &common
  env_file: .env
  build:
    dockerfile: Dockerfile
  restart: always
  networks:
    - lipebol-network
  deploy:
    resources:
      limits:
        cpus: 2
        memory: 2048M
        pids: 200
  memswap_limit: 4096M
  logging:
    options:
      max-size: 10M
      max-file: 3
  security_opt:
    - no-new-privileges=true
  environment:
    - PUID=1000
    - PGID=1000

services:
  postgresql:
    <<: *common
    image: postgres:latest
    container_name: postgresql
    environment:
      POSTGRES_USER: lipebol
      POSTGRES_PASSWORD: ${POSTGRESQL_PASSWORD}
      POSTGRES_DB: dockerized
    expose:
      - 5432
    volumes:
      - pgdata:/var/lib/postgresql/data

  mongodb:
    <<: *common
    image: mongodb/mongodb-community-server
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: lipebol
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD} 
    expose:
      - 27017
    volumes:
      - mongodb-data:/data/db

  airflow:
    <<: *common
    command: |
      bash -c "
        airflow api-server --port 8080 &
        airflow scheduler &
        airflow dag-processor &
        airflow triggerer &
        tail -f /dev/null
      "
    build:
      context: ./airflow-with-R/local
    image: lipebol/airflow:v1
    container_name: airflow-with-r
    ports:
      - 8080:8080
    volumes:
      - ./airflow-with-R/local/configurations/airflow.cfg:/opt/user/dockerized/airflow/airflow.cfg
      - ./airflow-with-R/local/dags:/opt/user/dockerized/airflow/dags
    working_dir: /opt/user/dockerized/airflow
    deploy:
      resources:
        limits:
          cpus: 4
          memory: 4096M
    memswap_limit: 8192M
  
  xfce:
    <<: *common
    image: lscr.io/linuxserver/rdesktop:ubuntu-xfce
    container_name: xfce
    security_opt:
      - seccomp:unconfined
    environment:
      - TZ=America/Sao_Paulo
    ports:
      - 3389:3389
    volumes:
      - xfce-data:/config
    devices:
      - /dev/dri:/dev/dri
    shm_size: 1gb

  pgadmin4:
    <<: *common
    image: dpage/pgadmin4
    container_name: pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: lipebol@domain.com
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN4_PASSWORD}
      PGADMIN_CONFIG_CONSOLE_LOG_LEVEL: 10
    ports:
      - 5000:80

  rstudio:
    <<: *common
    image: rocker/rstudio
    container_name: rstudio
    environment:
      PASSWORD: ${RSTUDIO_PASSWORD}
    ports:
      - 8888:8787
    volumes:
      - ./rstudio:/srv/rstudio
    working_dir: /srv/rstudio
    deploy:
      resources:
        limits:
          cpus: 4
          memory: 4096M
    memswap_limit: 8192M
  
  nginx:
    <<: *common
    build:
      context: ./nginx-reverse-proxy
    image: lipebol/nginx:v1
    container_name: nginx-reverse-proxy
    ports:
      - 80:80
    volumes:
      - ./nginx-reverse-proxy/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx-reverse-proxy/conf/default.conf.template:/etc/nginx/conf.d/default.conf
      - ./nginx-reverse-proxy/public:/usr/share/nginx/html

networks:
  lipebol-network:
    external: true
    name: lipebol-network

volumes:
  pgdata:
    external: true
    name: pgdata
  mongodb-data:
    external: true
    name: mongodb-data
  xfce-data:
    external: true
    name: xfce-data
